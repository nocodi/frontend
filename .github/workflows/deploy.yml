name: deploy

on:
  workflow_run:
    workflows: ["build"]
    branches: [deploy/frontend-v1.0]
    types:
      - completed
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-22.04
    environment: SE shared

    permissions:
      contents: read
      packages: write

    steps:
      - name: deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_KEY }}
          port: ${{ secrets.PROD_PORT }}
          script: |
            docker run --pull=always -p 3000:80 ghcr.io/nocodi/frontend:latest

      - name: notify
        run: |
          message="🚀Nocodi Frontend deployed"
          message="$message\n👤 Author: ${{ github.event.workflow_run.head_commit.author.name }}"
          message="$message\n📝 Commit Message: ${{ github.event.workflow_run.head_commit.message }}"
          message="$message\n🔍 Commit Hash: ${{ github.event.workflow_run.head_commit.id }}"

          curl -s https://api.telegram.org/bot${{ secrets.TGBOT_TOKEN }}/sendMessage \
          -d "{\"chat_id\":\"${{ secrets.TGCHAT_ID }}\", \"message_thread_id\": \"${{ secrets.TGMESSAGE_THREAD_ID }}\", \"text\": \"$message\"}" \
              -H 'Content-Type: Application/Json'